# Sequence Diagrams: Code Review Agent

## 1. Complete Review Flow (End-to-End)

```
┌──────┐     ┌──────┐     ┌──────────┐     ┌─────────┐     ┌────────┐     ┌────────┐     ┌──────┐
│ Cron │     │Agent │     │Discovery │     │Context  │     │Review  │     │Output  │     │VCS   │
│      │     │      │     │Service   │     │Builder  │     │Engine  │     │Manager │     │API   │
└──┬───┘     └───┬──┘     └────┬─────┘     └────┬────┘     └────┬───┘     └────┬───┘     └───┬──┘
   │             │              │                 │                │               │             │
   │ trigger     │              │                 │                │               │             │
   ├────────────>│              │                 │                │               │             │
   │             │              │                 │                │               │             │
   │             │ discover()   │                 │                │               │             │
   │             ├─────────────>│                 │                │               │             │
   │             │              │                 │                │               │             │
   │             │              │ listPRs()       │                │               │             │
   │             │              ├─────────────────────────────────────────────────────────────>│
   │             │              │                 │                │               │             │
   │             │              │ PRs[]           │                │               │             │
   │             │              │<─────────────────────────────────────────────────────────────┤
   │             │              │                 │                │               │             │
   │             │              │ filter(7days, open, unreviewed)  │               │             │
   │             │              │─────┐           │                │               │             │
   │             │              │     │           │                │               │             │
   │             │              │<────┘           │                │               │             │
   │             │              │                 │                │               │             │
   │             │ PRs[]        │                 │                │               │             │
   │             │<─────────────┤                 │                │               │             │
   │             │              │                 │                │               │             │
   │             │ enqueue(PRs) │                 │                │               │             │
   │             │─────┐        │                 │                │               │             │
   │             │     │ [DB]   │                 │                │               │             │
   │             │<────┘        │                 │                │               │             │
   │             │              │                 │                │               │             │
   │             │ loop [each PR in queue]        │                │               │             │
   │             │─────────────────────────────────────────────────────────────────────────────┐│
   │             ││             │                 │                │               │            ││
   │             ││ buildContext(PR)              │                │               │            ││
   │             │├──────────────────────────────>│                │               │            ││
   │             ││             │                 │                │               │            ││
   │             ││             │                 │ clone()        │               │            ││
   │             ││             │                 ├────────────────────────────────────────────>│
   │             ││             │                 │                │               │            ││
   │             ││             │                 │ repo/          │               │            ││
   │             ││             │                 │<────────────────────────────────────────────┤
   │             ││             │                 │                │               │            ││
   │             ││             │                 │ getDiff()      │               │            ││
   │             ││             │                 ├────────────────────────────────────────────>│
   │             ││             │                 │                │               │            ││
   │             ││             │                 │ diff           │               │            ││
   │             ││             │                 │<────────────────────────────────────────────┤
   │             ││             │                 │                │               │            ││
   │             ││             │                 │ analyzeDeps()  │               │            ││
   │             ││             │                 │─────┐          │               │            ││
   │             ││             │                 │     │          │               │            ││
   │             ││             │                 │<────┘          │               │            ││
   │             ││             │                 │                │               │            ││
   │             ││             │                 │ calcCoverage() │               │            ││
   │             ││             │                 │─────┐          │               │            ││
   │             ││             │                 │     │          │               │            ││
   │             ││             │                 │<────┘          │               │            ││
   │             ││             │                 │                │               │            ││
   │             ││             │ context         │                │               │            ││
   │             ││<──────────────────────────────┤                │               │            ││
   │             ││             │                 │                │               │            ││
   │             ││ review(context)               │                │               │            ││
   │             │├──────────────────────────────────────────────>│               │            ││
   │             ││             │                 │                │               │            ││
   │             ││             │                 │                │ runRules()    │            ││
   │             ││             │                 │                │─────┐         │            ││
   │             ││             │                 │                │     │         │            ││
   │             ││             │                 │                │<────┘         │            ││
   │             ││             │                 │                │               │            ││
   │             ││             │                 │                │ claudeAnalysis()          ││
   │             ││             │                 │                │─────┐         │            ││
   │             ││             │                 │                │     │ [Claude API]        ││
   │             ││             │                 │                │<────┘         │            ││
   │             ││             │                 │                │               │            ││
   │             ││             │                 │                │ makeDecision()│            ││
   │             ││             │                 │                │─────┐         │            ││
   │             ││             │                 │                │     │         │            ││
   │             ││             │                 │                │<────┘         │            ││
   │             ││             │                 │                │               │            ││
   │             ││             │                 │ result         │               │            ││
   │             ││<──────────────────────────────────────────────┤               │            ││
   │             ││             │                 │                │               │            ││
   │             ││ saveReview(result)            │                │               │            ││
   │             ││─────┐       │                 │                │               │            ││
   │             ││     │ [DB]  │                 │                │               │            ││
   │             ││<────┘       │                 │                │               │            ││
   │             ││             │                 │                │               │            ││
   │             ││ postReview(result)            │                │               │            ││
   │             │├──────────────────────────────────────────────────────────────>│            ││
   │             ││             │                 │                │               │            ││
   │             ││             │                 │                │               │ createReview()
   │             ││             │                 │                │               ├───────────>│
   │             ││             │                 │                │               │            ││
   │             ││             │                 │                │               │ success    ││
   │             ││             │                 │                │               │<───────────┤
   │             ││             │                 │                │               │            ││
   │             ││             │                 │                │               │ updateLabels()
   │             ││             │                 │                │               ├───────────>│
   │             ││             │                 │                │               │            ││
   │             ││             │                 │                │               │ success    ││
   │             ││             │                 │                │               │<───────────┤
   │             ││             │                 │                │               │            ││
   │             ││ complete    │                 │                │               │            ││
   │             ││<──────────────────────────────────────────────────────────────┤            ││
   │             │<─────────────────────────────────────────────────────────────────────────────┘│
   │             │              │                 │                │               │             │
   │ done        │              │                 │                │               │             │
   │<────────────┤              │                 │                │               │             │
```

## 2. PR Discovery Flow (Detailed)

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────┐     ┌──────┐
│Discovery │     │  Rate    │     │  MCP     │     │ Database │     │GitHub│     │GitLab│
│Service   │     │ Limiter  │     │Connector │     │          │     │ API  │     │ API  │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └───┬──┘     └───┬──┘
     │                │                 │                 │                │            │
     │ discoverPRs()  │                 │                 │                │            │
     │─────┐          │                 │                 │                │            │
     │     │          │                 │                 │                │            │
     │<────┘          │                 │                 │                │            │
     │                │                 │                 │                │            │
     │ getRepos()     │                 │                 │                │            │
     ├────────────────────────────────────────────────────>               │            │
     │                │                 │                 │                │            │
     │ repos[]        │                 │                 │                │            │
     │<────────────────────────────────────────────────────               │            │
     │                │                 │                 │                │            │
     │ parallel loop [each repo]        │                 │                │            │
     │─────────────────────────────────────────────────────────────────────────────────┐
     ││               │                 │                 │                │           ││
     ││ acquire()     │                 │                 │                │           ││
     ││──────────────>│                 │                 │                │           ││
     ││               │                 │                 │                │           ││
     ││ token         │                 │                 │                │           ││
     ││<──────────────┤                 │                 │                │           ││
     ││               │                 │                 │                │           ││
     ││ listPRs(repo, {state:open, created:>7days})      │                │           ││
     ││───────────────────────────────>│                 │                │           ││
     ││               │                 │                 │                │           ││
     ││               │                 │ GET /repos/:owner/:repo/pulls   │           ││
     ││               │                 ├─────────────────────────────────>           ││
     ││               │                 │                 │                │           ││
     ││               │                 │ PRs[]           │                │           ││
     ││               │                 │<─────────────────────────────────           ││
     ││               │                 │                 │                │           ││
     ││               │ PRs[]           │                 │                │           ││
     ││<───────────────────────────────┤                 │                │           ││
     ││               │                 │                 │                │           ││
     ││ release()     │                 │                 │                │           ││
     ││──────────────>│                 │                 │                │           ││
     ││               │                 │                 │                │           ││
     ││ loop [each PR]│                 │                 │                │           ││
     ││───────────────────────────────────────────────────────────────────────────────┐│
     │││              │                 │                 │                │          │││
     │││ checkIfReviewed(PR)            │                 │                │          │││
     │││────────────────────────────────────────────────>│                │          │││
     │││              │                 │                 │                │          │││
     │││              │                 │  SELECT * FROM pull_requests    │          │││
     │││              │                 │  WHERE pr_id = ? AND            │          │││
     │││              │                 │  (last_reviewed_at IS NULL OR   │          │││
     │││              │                 │   updated_at > last_reviewed_at)│          │││
     │││              │                 │                 │─────┐          │          │││
     │││              │                 │                 │     │          │          │││
     │││              │                 │                 │<────┘          │          │││
     │││              │                 │                 │                │          │││
     │││              │                 │ needsReview=true│                │          │││
     │││<────────────────────────────────────────────────┤                │          │││
     │││              │                 │                 │                │          │││
     │││ [if needs review] upsertPR(PR) │                │                │          │││
     │││────────────────────────────────────────────────>│                │          │││
     │││              │                 │                 │                │          │││
     │││              │                 │  INSERT OR UPDATE pull_requests │          │││
     │││              │                 │                 │─────┐          │          │││
     │││              │                 │                 │     │          │          │││
     │││              │                 │                 │<────┘          │          │││
     │││              │                 │                 │                │          │││
     │││              │                 │ prId            │                │          │││
     │││<────────────────────────────────────────────────┤                │          │││
     │││              │                 │                 │                │          │││
     │││ add to filtered[]             │                 │                │          │││
     │││─────┐        │                 │                 │                │          │││
     │││     │        │                 │                 │                │          │││
     │││<────┘        │                 │                 │                │          │││
     ││<───────────────────────────────────────────────────────────────────────────────┘│
     │<─────────────────────────────────────────────────────────────────────────────────┘
     │                │                 │                 │                │            │
     │ return PRs[]   │                 │                 │                │            │
     │─────┐          │                 │                 │                │            │
     │     │          │                 │                 │                │            │
     │<────┘          │                 │                 │                │            │
```

## 3. Context Building Flow (Detailed)

```
┌─────────┐     ┌────────┐     ┌──────┐     ┌────────┐     ┌──────────┐     ┌─────────┐
│Context  │     │  Repo  │     │ Diff │     │  Dep   │     │ Coverage │     │  Build  │
│Builder  │     │Manager │     │Extractor   │Analyzer│     │Calculator│     │Integrator
└────┬────┘     └───┬────┘     └───┬──┘     └───┬────┘     └─────┬────┘     └────┬────┘
     │              │                │            │                 │               │
     │ buildContext(PR)              │            │                 │               │
     │─────┐        │                │            │                 │               │
     │     │        │                │            │                 │               │
     │<────┘        │                │            │                 │               │
     │              │                │            │                 │               │
     │ cloneAndCheckout(repo, branch, pr)        │                 │               │
     │─────────────>│                │            │                 │               │
     │              │                │            │                 │               │
     │              │ git clone --depth=1        │                 │               │
     │              │─────┐          │            │                 │               │
     │              │     │          │            │                 │               │
     │              │<────┘          │            │                 │               │
     │              │                │            │                 │               │
     │              │ git fetch pull/123/head    │                 │               │
     │              │─────┐          │            │                 │               │
     │              │     │          │            │                 │               │
     │              │<────┘          │            │                 │               │
     │              │                │            │                 │               │
     │              │ git checkout pr-123        │                 │               │
     │              │─────┐          │            │                 │               │
     │              │     │          │            │                 │               │
     │              │<────┘          │            │                 │               │
     │              │                │            │                 │               │
     │ { git, path }│                │            │                 │               │
     │<─────────────┤                │            │                 │               │
     │              │                │            │                 │               │
     │ extractDiff(git, baseBranch)  │            │                 │               │
     │──────────────────────────────>│            │                 │               │
     │              │                │            │                 │               │
     │              │                │ git diff main...HEAD         │               │
     │              │                │─────┐      │                 │               │
     │              │                │     │      │                 │               │
     │              │                │<────┘      │                 │               │
     │              │                │            │                 │               │
     │              │                │ parse diff with +/-10 lines  │               │
     │              │                │─────┐      │                 │               │
     │              │                │     │      │                 │               │
     │              │                │<────┘      │                 │               │
     │              │                │            │                 │               │
     │              │                │ loop [each file]             │               │
     │              │                │─────────────────────────────────────────────┐│
     │              │                ││ git show HEAD:file          │              ││
     │              │                ││─────┐      │                 │              ││
     │              │                ││     │      │                 │              ││
     │              │                ││<────┘      │                 │              ││
     │              │                ││            │                 │              ││
     │              │                ││ add context lines           │              ││
     │              │                ││─────┐      │                 │              ││
     │              │                ││     │      │                 │              ││
     │              │                ││<────┘      │                 │              ││
     │              │                │<─────────────────────────────────────────────┘│
     │              │                │            │                 │               │
     │              │ diffContext    │            │                 │               │
     │<──────────────────────────────┤            │                 │               │
     │              │                │            │                 │               │
     │ analyzeDependencies(path, modifiedFiles)  │                 │               │
     │───────────────────────────────────────────>│                 │               │
     │              │                │            │                 │               │
     │              │                │            │ madge(repoPath) │               │
     │              │                │            │─────┐           │               │
     │              │                │            │     │           │               │
     │              │                │            │<────┘           │               │
     │              │                │            │                 │               │
     │              │                │            │ findDependents()│               │
     │              │                │            │─────┐           │               │
     │              │                │            │     │           │               │
     │              │                │            │<────┘           │               │
     │              │                │            │                 │               │
     │              │                │            │ findDependencies()             │
     │              │                │            │─────┐           │               │
     │              │                │            │     │           │               │
     │              │                │            │<────┘           │               │
     │              │                │            │                 │               │
     │              │                │ depGraph   │                 │               │
     │<───────────────────────────────────────────┤                 │               │
     │              │                │            │                 │               │
     │ calculateCoverageDelta(path, modifiedFiles)│                 │               │
     │────────────────────────────────────────────────────────────>│               │
     │              │                │            │                 │               │
     │              │                │            │  read coverage-final.json      │
     │              │                │            │                 │─────┐         │
     │              │                │            │                 │     │         │
     │              │                │            │                 │<────┘         │
     │              │                │            │                 │               │
     │              │                │            │  createCoverageMap()           │
     │              │                │            │                 │─────┐         │
     │              │                │            │                 │     │         │
     │              │                │            │                 │<────┘         │
     │              │                │            │                 │               │
     │              │                │            │  calculate stats for files     │
     │              │                │            │                 │─────┐         │
     │              │                │            │                 │     │         │
     │              │                │            │                 │<────┘         │
     │              │                │            │                 │               │
     │              │                │            │  coverageDelta  │               │
     │<────────────────────────────────────────────────────────────┤               │
     │              │                │            │                 │               │
     │ fetchBuildStatus(pr)          │            │                 │               │
     │───────────────────────────────────────────────────────────────────────────>│
     │              │                │            │                 │               │
     │              │                │            │                 │  GET /repos/:owner/:repo/
     │              │                │            │                 │  commits/:sha/status
     │              │                │            │                 │               │─────┐
     │              │                │            │                 │               │     │
     │              │                │            │                 │               │<────┘
     │              │                │            │                 │               │
     │              │                │            │                 │  buildInfo    │
     │<───────────────────────────────────────────────────────────────────────────┤
     │              │                │            │                 │               │
     │ return ReviewContext { repo, pr, diff, deps, coverage, build, commits, arch }
     │─────┐        │                │            │                 │               │
     │     │        │                │            │                 │               │
     │<────┘        │                │            │                 │               │
```

## 4. Review Execution Flow (Detailed)

```
┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐     ┌─────────┐
│Review  │     │  Rule  │     │ Claude │     │Decision│     │Database│     │ Claude  │
│Engine  │     │Executor│     │Analyzer│     │ Maker  │     │        │     │   API   │
└───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘     └────┬────┘
    │              │                │              │              │                │
    │ review(context)               │              │              │                │
    │─────┐        │                │              │              │                │
    │     │        │                │              │              │                │
    │<────┘        │                │              │              │                │
    │              │                │              │              │                │
    │ loadRules(config)             │              │              │                │
    │─────┐        │                │              │              │                │
    │     │        │                │              │              │                │
    │<────┘        │                │              │              │                │
    │              │                │              │              │                │
    │ group by category             │              │              │                │
    │─────┐        │                │              │              │                │
    │     │        │                │              │              │                │
    │<────┘        │                │              │              │                │
    │              │                │              │              │                │
    │ loop [each category]          │              │              │                │
    │───────────────────────────────────────────────────────────────────────────┐ │
    ││             │                │              │              │              │ │
    ││ runRuleGroup(rules, context) │              │              │              │ │
    ││────────────>│                │              │              │              │ │
    ││             │                │              │              │              │ │
    ││             │ parallel [each rule]          │              │              │ │
    ││             │───────────────────────────────────────────────────────────┐│ │
    ││             ││               │              │              │             ││ │
    ││             ││ rule.check(context)         │              │             ││ │
    ││             ││─────┐         │              │              │             ││ │
    ││             ││     │ [AST parsing, pattern matching, etc] │             ││ │
    ││             ││<────┘         │              │              │             ││ │
    ││             ││               │              │              │             ││ │
    ││             ││ violations[]  │              │              │             ││ │
    ││             ││─────┐         │              │              │             ││ │
    ││             ││     │         │              │              │             ││ │
    ││             ││<────┘         │              │              │             ││ │
    ││             │<───────────────────────────────────────────────────────────┘│ │
    ││             │                │              │              │              │ │
    ││ violations[]│                │              │              │              │ │
    ││<────────────┤                │              │              │              │ │
    │<───────────────────────────────────────────────────────────────────────────┘ │
    │              │                │              │              │                │
    │ runClaudeAnalysis(context, violations)      │              │                │
    │─────────────────────────────>│              │              │                │
    │              │                │              │              │                │
    │              │                │ buildPrompt()│              │                │
    │              │                │─────┐        │              │                │
    │              │                │     │        │              │                │
    │              │                │<────┘        │              │                │
    │              │                │              │              │                │
    │              │                │ POST /messages              │                │
    │              │                ├─────────────────────────────────────────────>│
    │              │                │              │              │                │
    │              │                │   {          │              │                │
    │              │                │     model: "claude-3-5-sonnet",             │
    │              │                │     messages: [...],        │                │
    │              │                │     max_tokens: 4096        │                │
    │              │                │   }          │              │                │
    │              │                │              │              │                │
    │              │                │ response     │              │                │
    │              │                │<─────────────────────────────────────────────┤
    │              │                │              │              │                │
    │              │                │ parseResponse()            │                │
    │              │                │─────┐        │              │                │
    │              │                │     │        │              │                │
    │              │                │<────┘        │              │                │
    │              │                │              │              │                │
    │              │ aiReview       │              │              │                │
    │<─────────────────────────────┤              │              │                │
    │              │                │              │              │                │
    │ generateComments(violations, context)       │              │                │
    │─────┐        │                │              │              │                │
    │     │        │                │              │              │                │
    │<────┘        │                │              │              │                │
    │              │                │              │              │                │
    │ makeDecision(violations, context)           │              │                │
    │─────────────────────────────────────────────>              │                │
    │              │                │              │              │                │
    │              │                │              │ check thresholds             │
    │              │                │              │─────┐        │                │
    │              │                │              │     │        │                │
    │              │                │              │<────┘        │                │
    │              │                │              │              │                │
    │              │                │              │ logDecision()│                │
    │              │                │              ├─────────────>│                │
    │              │                │              │              │                │
    │              │                │              │  INSERT INTO decision_log    │
    │              │                │              │              │─────┐          │
    │              │                │              │              │     │          │
    │              │                │              │              │<────┘          │
    │              │                │              │              │                │
    │              │                │              │ done         │                │
    │              │                │              │<─────────────┤                │
    │              │                │              │              │                │
    │              │                │ decision     │              │                │
    │<─────────────────────────────────────────────              │                │
    │              │                │              │              │                │
    │ return ReviewResult { comments, summary, decision, metrics }               │
    │─────┐        │                │              │              │                │
    │     │        │                │              │              │                │
    │<────┘        │                │              │              │                │
```

## 5. Output Posting Flow (Detailed)

```
┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐     ┌──────┐
│Output  │     │Comment │     │Template│     │Database│     │GitHub│
│Manager │     │Formatter     │Engine  │     │        │     │ API  │
└───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘     └───┬──┘
    │              │                │              │              │
    │ postReview(repo, pr, result) │              │              │
    │─────┐        │                │              │              │
    │     │        │                │              │              │
    │<────┘        │                │              │              │
    │              │                │              │              │
    │ loop [each comment in result.comments]      │              │
    │─────────────────────────────────────────────────────────────┐
    ││             │                │              │             ││
    ││ renderInlineComment(comment)│              │             ││
    ││─────────────>               │              │             ││
    ││             │                │              │             ││
    ││             │ getTemplate('inline-comment')│             ││
    ││             ├───────────────>              │             ││
    ││             │                │              │             ││
    ││             │ template       │              │             ││
    ││             │<───────────────┤              │             ││
    ││             │                │              │             ││
    ││             │ template({ severity, message, ... })       ││
    ││             │─────┐          │              │             ││
    ││             │     │          │              │             ││
    ││             │<────┘          │              │             ││
    ││             │                │              │             ││
    ││ rendered    │                │              │             ││
    ││<─────────────               │              │             ││
    ││             │                │              │             ││
    ││ add to comments[]           │              │             ││
    ││─────┐       │                │              │             ││
    ││     │       │                │              │             ││
    ││<────┘       │                │              │             ││
    │<─────────────────────────────────────────────────────────────┘
    │              │                │              │              │
    │ renderSummary(result)        │              │              │
    │─────────────>                │              │              │
    │              │                │              │              │
    │              │ groupByCategory()            │              │
    │              │─────┐          │              │              │
    │              │     │          │              │              │
    │              │<────┘          │              │              │
    │              │                │              │              │
    │              │ extractRefactorings()        │              │
    │              │─────┐          │              │              │
    │              │     │          │              │              │
    │              │<────┘          │              │              │
    │              │                │              │              │
    │              │ generateResources()          │              │
    │              │─────┐          │              │              │
    │              │     │          │              │              │
    │              │<────┘          │              │              │
    │              │                │              │              │
    │              │ getTemplate('summary')       │              │
    │              ├───────────────>              │              │
    │              │                │              │              │
    │              │ template       │              │              │
    │              │<───────────────┤              │              │
    │              │                │              │              │
    │              │ template({     │              │              │
    │              │   decision,    │              │              │
    │              │   metrics,     │              │              │
    │              │   issuesByCategory,          │              │
    │              │   refactorings,│              │              │
    │              │   resources    │              │              │
    │              │ })             │              │              │
    │              │─────┐          │              │              │
    │              │     │          │              │              │
    │              │<────┘          │              │              │
    │              │                │              │              │
    │ summary     │                │              │              │
    │<─────────────                │              │              │
    │              │                │              │              │
    │ POST /repos/:owner/:repo/pulls/:number/reviews             │
    ├────────────────────────────────────────────────────────────>
    │              │                │              │              │
    │   {         │                │              │              │
    │     event: "REQUEST_CHANGES",│              │              │
    │     body: summary,            │              │              │
    │     comments: [              │              │              │
    │       { path, line, body },  │              │              │
    │       ...                    │              │              │
    │     ]        │                │              │              │
    │   }          │                │              │              │
    │              │                │              │              │
    │ { id, comments: [{id, ...}] }│              │              │
    │<────────────────────────────────────────────────────────────┤
    │              │                │              │              │
    │ updateCommentIds(reviewId, commentIds)      │              │
    │─────────────────────────────────────────────>              │
    │              │                │              │              │
    │              │                │  UPDATE review_comments    │
    │              │                │  SET posted = 1,           │
    │              │                │      comment_id = ?,       │
    │              │                │      posted_at = ?         │
    │              │                │  WHERE id = ?              │
    │              │                │              │─────┐        │
    │              │                │              │     │        │
    │              │                │              │<────┘        │
    │              │                │              │              │
    │              │                │ done         │              │
    │<─────────────────────────────────────────────              │
    │              │                │              │              │
    │ updateLabels(owner, repo, prNumber, result) │              │
    │─────┐        │                │              │              │
    │     │        │                │              │              │
    │<────┘        │                │              │              │
    │              │                │              │              │
    │ calculateLabels(result)      │              │              │
    │─────┐        │                │              │              │
    │     │        │                │              │              │
    │<────┘        │                │              │              │
    │              │                │              │              │
    │ POST /repos/:owner/:repo/issues/:number/labels             │
    ├────────────────────────────────────────────────────────────>
    │              │                │              │              │
    │   {         │                │              │              │
    │     labels: ["code-review-agent", "critical-issues", ...]  │
    │   }          │                │              │              │
    │              │                │              │              │
    │ success      │                │              │              │
    │<────────────────────────────────────────────────────────────┤
    │              │                │              │              │
    │ return       │                │              │              │
    │─────┐        │                │              │              │
    │     │        │                │              │              │
    │<────┘        │                │              │              │
```

## 6. Error Handling & Retry Flow

```
┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐     ┌──────┐
│  Error │     │ Retry  │     │Queue   │     │Database│     │ VCS  │
│Boundary│     │Logic   │     │Processor     │        │     │ API  │
└───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘     └───┬──┘
    │              │                │              │              │
    │ execute(operation, fallback, opts)          │              │
    │─────┐        │                │              │              │
    │     │        │                │              │              │
    │<────┘        │                │              │              │
    │              │                │              │              │
    │ attempt = 0  │                │              │              │
    │─────┐        │                │              │              │
    │     │        │                │              │              │
    │<────┘        │                │              │              │
    │              │                │              │              │
    │ loop [attempt <= retries]    │              │              │
    │──────────────────────────────────────────────────────────────┐
    ││             │                │              │             ││
    ││ try         │                │              │             ││
    ││─────┐       │                │              │             ││
    ││     │       │                │              │             ││
    ││<────┘       │                │              │             ││
    ││             │                │              │             ││
    ││ withTimeout(operation, timeout)            │             ││
    ││─────┐       │                │              │             ││
    ││     │       │                │              │             ││
    ││<────┘       │                │              │             ││
    ││             │                │              │             ││
    ││ operation() │                │              │             ││
    ││─────────────────────────────────────────────────────────>││
    ││             │                │              │             ││
    ││ [if error]  │                │              │             ││
    ││ error       │                │              │             ││
    ││<─────────────────────────────────────────────────────────┤│
    ││             │                │              │             ││
    ││ catch(error)│                │              │             ││
    ││─────┐       │                │              │             ││
    ││     │       │                │              │             ││
    ││<────┘       │                │              │             ││
    ││             │                │              │             ││
    ││ log error   │                │              │             ││
    ││─────┐       │                │              │             ││
    ││     │       │                │              │             ││
    ││<────┘       │                │              │             ││
    ││             │                │              │             ││
    ││ [if attempt < retries]      │              │             ││
    ││ calculateBackoff(attempt)   │              │             ││
    ││─────────────>               │              │             ││
    ││             │                │              │             ││
    ││             │ delay = 1000 * 2^attempt     │             ││
    ││             │─────┐          │              │             ││
    ││             │     │          │              │             ││
    ││             │<────┘          │              │             ││
    ││             │                │              │             ││
    ││ delay       │                │              │             ││
    ││<─────────────               │              │             ││
    ││             │                │              │             ││
    ││ sleep(delay)│                │              │             ││
    ││─────┐       │                │              │             ││
    ││     │       │                │              │             ││
    ││<────┘       │                │              │             ││
    ││             │                │              │             ││
    ││ attempt++   │                │              │             ││
    ││─────┐       │                │              │             ││
    ││     │       │                │              │             ││
    ││<────┘       │                │              │             ││
    │<──────────────────────────────────────────────────────────────┘
    │              │                │              │              │
    │ [if all retries exhausted && fallback exists]             │
    │ try fallback()               │              │              │
    │─────┐        │                │              │              │
    │     │        │                │              │              │
    │<────┘        │                │              │              │
    │              │                │              │              │
    │ fallback()   │                │              │              │
    │─────┐        │                │              │              │
    │     │        │                │              │              │
    │<────┘        │                │              │              │
    │              │                │              │              │
    │ [if fallback fails]          │              │              │
    │ updateQueueStatus(id, 'failed', error)      │              │
    │─────────────────────────────────────────────>              │
    │              │                │              │              │
    │              │                │  UPDATE review_queue       │
    │              │                │  SET status = 'failed',    │
    │              │                │      retry_count++,        │
    │              │                │      error_message = ?     │
    │              │                │              │─────┐        │
    │              │                │              │     │        │
    │              │                │              │<────┘        │
    │              │                │              │              │
    │              │                │ done         │              │
    │<─────────────────────────────────────────────              │
    │              │                │              │              │
    │ throw error  │                │              │              │
    │─────┐        │                │              │              │
    │     │        │                │              │              │
    │<────┘        │                │              │              │
```

## 7. Dry-Run vs Production Mode Flow

```
┌────────┐     ┌────────┐     ┌────────┐     ┌──────┐
│  Main  │     │ Config │     │ Output │     │ VCS  │
│  App   │     │Loader  │     │Manager │     │ API  │
└───┬────┘     └───┬────┘     └───┬────┘     └───┬──┘
    │              │                │              │
    │ start()      │                │              │
    │─────┐        │                │              │
    │     │        │                │              │
    │<────┘        │                │              │
    │              │                │              │
    │ getConfig()  │                │              │
    │─────────────>│                │              │
    │              │                │              │
    │ config       │                │              │
    │<─────────────┤                │              │
    │              │                │              │
    │ [if config.execution.mode === 'dry-run']    │
    │ log('DRY-RUN MODE')           │              │
    │─────┐        │                │              │
    │     │        │                │              │
    │<────┘        │                │              │
    │              │                │              │
    │ ... discovery, context, review ...          │
    │              │                │              │
    │ reviewPullRequest(pr)         │              │
    │─────┐        │                │              │
    │     │        │                │              │
    │<────┘        │                │              │
    │              │                │              │
    │ ... context building & review ...           │
    │              │                │              │
    │ [save to database with execution_mode='dry-run']
    │              │                │              │
    │ [if mode === 'production']   │              │
    │ postReview(repo, pr, result) │              │
    │──────────────────────────────>              │
    │              │                │              │
    │              │                │ POST review │
    │              │                ├─────────────>│
    │              │                │              │
    │              │                │ success      │
    │              │                │<─────────────┤
    │              │                │              │
    │ complete     │                │              │
    │<──────────────────────────────┤              │
    │              │                │              │
    │ log('Review posted: REQUEST_CHANGES')       │
    │─────┐        │                │              │
    │     │        │                │              │
    │<────┘        │                │              │
    │              │                │              │
    │ [else mode === 'dry-run']    │              │
    │ log('[DRY-RUN] Would post: REQUEST_CHANGES')│
    │─────┐        │                │              │
    │     │        │                │              │
    │<────┘        │                │              │
    │              │                │              │
    │ log('[DRY-RUN] Found 10 issues:')           │
    │─────┐        │                │              │
    │     │        │                │              │
    │<────┘        │                │              │
    │              │                │              │
    │ loop [each comment]           │              │
    │──────────────────────────────────────────────┐
    ││             │                │             ││
    ││ log('[DRY-RUN] file.ts:42 - [critical] ...')
    ││─────┐       │                │             ││
    ││     │       │                │             ││
    ││<────┘       │                │             ││
    │<──────────────────────────────────────────────┘
    │              │                │              │
    │ return (no API calls made)   │              │
    │─────┐        │                │              │
    │     │        │                │              │
    │<────┘        │                │              │
```

## Key Timing & Performance Metrics

### Target Timings
- **PR Discovery**: 5-10s for 100 repositories
- **Repository Clone**: 2-5s per repo (shallow clone)
- **Diff Extraction**: 1-2s per PR
- **Dependency Analysis**: 3-5s per PR
- **Coverage Calculation**: 1-2s per PR
- **Rule Execution**: 10-15s per PR
- **Claude Analysis**: 5-10s per PR
- **Total Review Time**: 25-40s for average PR (10 files, 500 lines)

### Concurrency
- **Discovery**: Process 5 repositories in parallel
- **Reviews**: Process 3 PRs in parallel
- **Rules**: Execute all rules within a category in parallel
- **API Calls**: Rate-limited per platform (GitHub: 10 concurrent, GitLab: 20)

### Memory Budget
- **Per Review**: Max 2GB
- **Repository Cache**: 500MB per repo
- **Rule Engine**: 200MB overhead
- **Claude API**: 100MB per request